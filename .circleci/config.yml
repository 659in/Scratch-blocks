version: 2.1
orbs:
  browser-tools: circleci/browser-tools@1
  node: circleci/node@5
aliases:
  - &defaults
    executor:
      name: node/default
      tag: '16.18-browsers'
commands:
  install_python2:
    steps:
      - run:
          name: Install Python 2
          command: |
            sudo apt-get update
            sudo apt-get install python2-minimal
            sudo update-alternatives --install /usr/bin/python python /usr/bin/python2 10
  test:
    steps:
      - run:
          name: Test
          # Note that CircleCI runs Xvfb on :99 by default, which doesn't seem to be documented.
          # If this starts failing, that might no longer be true.
          # In that case, try: xvfb-run -e /dev/stdout npm test
          command: DISPLAY=:99 npm test
  deploy_gh_pages:
    steps:
      - when:
          condition:
            not:
              matches: { pattern: "^renovate/.*", value: <<pipeline.git.branch>> }
          steps:
            - run:
                name: Deploy to GH Pages
                command: |
                  npm run --silent deploy -- -x -r https://${GH_TOKEN}@github.com/${TRAVIS_REPO_SLUG}.git
  deploy_npm:
    steps:
      - when:
          condition:
            or:
              - equal: [ master, <<pipeline.git.branch>> ]
              - equal: [ develop, <<pipeline.git.branch>> ]
              - matches: { pattern: "^hotfix.*", value: <<pipeline.git.branch>> }
              - matches: { pattern: "^release.*", value: <<pipeline.git.branch>> }
          steps:
            - run:
                name: Deploy to NPM
                command: |
                  export RELEASE_VERSION="0.1.0-prerelease.$(date +'%Y%m%d%H%M%S')"
                  if [[ "$TRAVIS_BRANCH" == hotfix/* ]]; then
                    export NPM_TAG=hotfix
                  else
                    export NPM_TAG=latest
                  fi
                  echo "Deploying version $RELEASE_VERSION to $NPM_TAG"
                  npm --no-git-tag-version version $RELEASE_VERSION
                  git config --global user.email $(git log --pretty=format:"%ae" -n1)
                  git config --global user.name $(git log --pretty=format:"%an" -n1)
                  npm set //registry.npmjs.org/:_authToken=$NPM_TOKEN
                  npm publish --tag $NPM_TAG
                  if npm info | grep -q $RELEASE_VERSION; then
                    git tag $RELEASE_VERSION
                    git push \
                      https://${GH_TOKEN}@github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}.git \
                      $RELEASE_VERSION
                  fi

jobs:
  default:
    <<: *defaults
    environment:
      # DETECT_CHROMEDRIVER_VERSION only works if Chrome is installed before installing NPM packages
      DETECT_CHROMEDRIVER_VERSION: "true"
    steps:
      - checkout
      - install_python2
      - browser-tools/install-chrome
      - node/install-packages
      - test
      - deploy_npm
      - deploy_gh_pages
workflows:
  version: 2
  default:
    jobs:
      - default
  # TODO: another job to replace i18n/sync_translations.sh
